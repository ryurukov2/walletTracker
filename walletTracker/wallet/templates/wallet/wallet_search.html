{% load static %}
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Enter Address</title>
    <script src="{% static 'django_eventstream/eventsource.min.js' %}"></script>
    <script src="{% static 'django_eventstream/reconnecting-eventsource.js' %}"></script>
  </head>
  <body onload="start();">
    {% comment %} <h1>Enter Address</h1> {% endcomment %}

    <form method="post">
      {% csrf_token %}
      <label for="address">Address:</label>
      <input type="text" id="address" name="address" required>
      <br>
      <input type="submit" value="Submit">
    </form>



    
    <div>
      {% if wallet_data.data_status == 'ready' %}
        {{ wallet_data.data_status }}
      {% else %}
        data loading
      {% endif %}
    </div>
    <section>
      <h2>{{ address }}</h2>
    </section>
    <!-- Current Balances and Values -->
    <section id="balances">
      <h2>Wallet Balances</h2>
      <div><!-- Content filled from context or channels -->
      <ul>

        {% for token_data in balances.values %}
        <li>{{ token_data.tokenSymbol }}: {{ token_data.balance }} | {{ token_data.usd_value }} </li>
        {% endfor %}
      </ul>
      </div>
    </section>
      
    <section id="transactions">
      <div><!-- Content filled from context or channels -->
        <h2>Transaction History</h2>
        <table>
          <tr>
            <th>Date</th>
            <th>Type</th>
            <th>Amount</th>
            <th>Currency</th>
          </tr>
          {% for transaction in transactions %}
          <tr>
            <td>{{ transaction.date }}</td>
            <td>{{ transaction.type }}</td>
            <td>{{ transaction.amount }}</td>
            <td>{{ transaction.currency }}</td>
          </tr>
          {% endfor %}
        </table>
      </div>
    </section>
      <!-- Total P/L -->
    <section>
      <h2>Total P/L</h2>
      <p>{{ total_pl }}</p>
    </section>
    <script>
        var start = function() {
            var es = new ReconnectingEventSource("/events/");
            es.onopen = function() {
                console.log('connected');
                const currentTime = Date.now(); 
                console.log(currentTime);
            };
            es.onerror = function() {
                console.log('connection error');
            };
            es.addEventListener('stream-reset', function(e) {
                e = JSON.parse(e.data);
                console.log('stream reset: ' + JSON.stringify(e.channels));
            }, false);
            es.addEventListener('stream-error', function(e) {
                // hard stop
                es.close();
                e = JSON.parse(e.data);
                console.log('stream error: ' + e.condition + ': ' + e.text);
            }, false);
            es.addEventListener('message', function(e) {
                {% comment %} console.log('message: ' + e.data); {% endcomment %}
                let resp = JSON.parse(e.data)
                console.log(resp)
            }, false);
        }
    </script>
  </body>
</html>
